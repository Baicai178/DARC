# DPS310气压测试系统

基于DPS310传感器的气密性测试系统，支持实时压力监测、自动化测试流程和友好的UI界面。

## 功能特点

- **高精度压力测量**：使用DPS310传感器，精度可达0.06hPa
- **自动化测试流程**：支持充气、稳定、测试、结果判定全自动化
- **实时图表显示**：动态显示压力变化曲线
- **多种显示单位**：支持Pa、kPa、hPa、MPa单位切换
- **历史记录**：保存最近4次测试的泄漏率结果
- **可配置参数**：测试时间、目标压力、通过阈值均可调节

## 硬件连接

### 传感器连接
- **DPS310传感器**：通过I2C接口连接
  - VCC → 3.3V
  - GND → GND
  - SDA → SDA
  - SCL → SCL

### 控制器件连接
- **气泵控制**：GPIO 17 (通过MOS管驱动)
- **电磁阀控制**：GPIO 18 (通过MOS管驱动)

### MOS管驱动电路
```
GPIO → 1kΩ电阻 → MOS管栅极
MOS管源极 → GND
MOS管漏极 → 气泵/电磁阀负极
电源正极 → 气泵/电磁阀正极
```

## UI界面元素

### 显示元素
- **Bar9**：测试进度条
  - 充气时：浅蓝色
  - 测试时：浅绿色快速闪烁
  - 通过：绿色常亮
  - 失败：橙色闪烁

- **jc2**：测试进度百分比显示

- **NGLED2**：测试指示灯
  - 默认：白色背景
  - 充气：浅蓝色背景
  - 测试：浅绿色背景(闪烁)
  - 通过：绿色背景
  - 失败：红色背景(闪烁)

- **NGPS2**：测试状态文字
  - 待机："待机"
  - 充气："充气中"
  - 测试："测试中"
  - 通过："PASS"
  - 失败："NG"

- **泄漏率历史显示**：
  - n32：第4次前的泄漏率
  - n22：第3次前的泄漏率
  - n12：第2次前的泄漏率
  - n02：最近一次的泄漏率

- **Chart2**：实时压力图表

### 控制元素
- **Button21**：测试开始按钮
- **Button16**：测试停止按钮

### 配置下拉菜单
- **time2**：测试时间选择
  - 选项：5s, 10s, 15s, 30s, 60s
  - 默认：10s

- **tpp2**：充气目标压力选择
  - 选项：500Pa, 1000Pa, 1500Pa, 2000Pa, 3000Pa
  - 默认：1000Pa

- **tss2**：通过条件选择
  - 选项：10Pa, 20Pa, 50Pa, 100Pa, 200Pa
  - 默认：50Pa

- **unit2**：显示单位选择
  - 选项：Pa, kPa, hPa, MPa
  - 默认：Pa

## 测试流程

### 1. 充气阶段 (TEST_INFLATING)
- 气泵开启，电磁阀关闭
- 压力上升到目标压力的95%时自动停止
- 进度条显示充气进度
- 指示灯显示浅蓝色

### 2. 稳定阶段 (TEST_STABILIZING)
- 气泵和电磁阀均关闭
- 等待2秒让压力稳定
- 记录基线压力值

### 3. 测试阶段 (TEST_TESTING)
- 监测压力变化
- 指示灯浅绿色闪烁
- 进度条显示测试进度

### 4. 结果判定
- 计算泄漏率 = 基线压力 - 当前压力
- 如果泄漏率 ≤ 通过阈值：测试通过
- 如果泄漏率 > 通过阈值：测试失败
- 更新历史记录

## 图表显示逻辑

### 动态范围调整
- **待机状态**：显示标准大气压附近(101.0-101.7kPa)
- **充气阶段**：从大气压到目标压力+边距
- **测试阶段**：以基线压力为中心±500Pa范围

### 实时更新
- 20Hz更新频率
- 50个数据点的滚动缓冲区
- 蓝色曲线显示压力变化

## 配置参数

### 可调参数
```cpp
// 测试时间选项 (毫秒)
5000, 10000, 15000, 30000, 60000

// 目标压力选项 (Pa)
500, 1000, 1500, 2000, 3000

// 通过阈值选项 (Pa)
10, 20, 50, 100, 200
```

### 固定参数
```cpp
#define STABILIZATION_TIME 2000      // 稳定时间 2秒
#define INFLATION_TIMEOUT 30000      // 充气超时 30秒
#define PRESSURE_TOLERANCE 0.95      // 压力到达容差 95%
#define BLINK_INTERVAL 500           // 闪烁间隔 500ms
```

## 使用说明

### 1. 硬件准备
1. 连接DPS310传感器到I2C接口
2. 连接气泵到GPIO 17 (通过MOS管)
3. 连接电磁阀到GPIO 18 (通过MOS管)
4. 确保被测试件正确连接到气路系统

### 2. 软件配置
1. 在UI设计器中设置所有必要的UI元素
2. 确保ui.h文件包含所有UI对象的声明
3. 根据需要调整dropdown_config.h中的参数

### 3. 测试操作
1. 选择测试时间、目标压力、通过阈值
2. 点击"测试开始"按钮
3. 系统自动执行充气→稳定→测试→判定流程
4. 观察实时图表和指示灯状态
5. 查看测试结果和历史记录

## 注意事项

### 安全要求
- 确保气路系统密封良好
- 测试压力不要超过被测件的承受范围
- 使用合适的MOS管驱动电路

### 精度要求
- DPS310传感器需要预热时间
- 避免温度剧烈变化
- 确保I2C通信稳定

### 维护建议
- 定期校验传感器精度
- 清理气路系统
- 检查MOS管驱动电路

## 故障排除

### 常见问题
1. **传感器初始化失败**
   - 检查I2C连接
   - 确认传感器供电正常
   - 检查地址冲突

2. **充气不到位**
   - 检查气泵工作状态
   - 确认气路密封性
   - 检查MOS管驱动

3. **测试结果异常**
   - 校验传感器精度
   - 检查测试环境温度
   - 确认被测件状态

### 调试信息
系统通过串口输出详细的调试信息：
- 传感器初始化状态
- 实时压力值
- 测试流程状态
- 硬件控制状态

## 技术参数

### DPS310传感器规格
- 压力测量范围：300-1200hPa
- 精度：±0.06hPa (典型值)
- 分辨率：0.01hPa
- 工作温度：-40°C to +85°C

### 系统性能
- 数据采集频率：20Hz
- 图表更新：实时
- 测试精度：取决于传感器精度和环境条件
- 响应时间：< 100ms

## 版本信息

- **版本**：1.0
- **更新日期**：2024
- **兼容性**：Arduino IDE, ESP32平台
- **依赖库**：
  - Adafruit_DPS310
  - LVGL
  - Wire (I2C)

---

如有技术问题或改进建议，请联系开发团队。
